<UserControl
    x:Class="ChatClient.Desktop.Views.ChatPages.ChatViews.ChatLeftPanelView"
    xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:vm="clr-namespace:ChatClient.Desktop.ViewModels.ChatPages.ChatViews"
    xmlns:suki="https://github.com/kikipoulet/SukiUI"
    xmlns:converter="clr-namespace:ChatClient.Avalonia.Converter;assembly=ChatClient.Avalonia"
    xmlns:chatViews="clr-namespace:ChatClient.Desktop.Views.ChatPages.ChatViews"
    xmlns:data="clr-namespace:ChatClient.Tool.Data;assembly=ChatClient.Tool"
    xmlns:avalonia="clr-namespace:Material.Icons.Avalonia;assembly=Material.Icons.Avalonia"
    xmlns:group="clr-namespace:ChatClient.Tool.Data.Group;assembly=ChatClient.Tool"
    xmlns:circleImage="clr-namespace:ChatClient.Avalonia.Controls.CircleImage;assembly=ChatClient.Avalonia"
    xmlns:searchBox="clr-namespace:ChatClient.Avalonia.Controls.SearchBox;assembly=ChatClient.Avalonia"
    d:DesignHeight="650"
    d:DesignWidth="300"
    FontSize="15"
    x:DataType="vm:ChatLeftPanelViewModel"
    mc:Ignorable="d">
    <UserControl.Resources>
        <converter:ChatMessageToStringConverter x:Key="ChatMessageToStringConverter" />
        <converter:DateTimeConverter x:Key="DateTimeConverter" />
        <DataTemplate x:Key="FriendMenu" DataType="data:FriendRelationDto">
            <ContextMenu Padding="0,0,10,0" Closed="OnContextMenuClosed">
                <MenuItem IsVisible="{Binding IsTop}" Header="取消置顶" Click="OnFriendTopMenuItemClick">
                    <MenuItem.Icon>
                        <avalonia:MaterialIcon Kind="ArrowExpandDown" />
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem IsVisible="{Binding !IsTop}" Header="置顶聊天" Click="OnFriendTopMenuItemClick">
                    <MenuItem.Icon>
                        <avalonia:MaterialIcon Kind="ArrowCollapseUp" />
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="复制群ID" Click="OnFriendCopyIdClick">
                    <MenuItem.Icon>
                        <avalonia:MaterialIcon Kind="ContentCopy" />
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem IsVisible="{Binding CantDisturb}" Header="接受消息提醒" Click="OnFriendDisturbMenuItemClick">
                    <MenuItem.Icon>
                        <avalonia:MaterialIcon Kind="BellOutline" />
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem IsVisible="{Binding !CantDisturb}" Header="消息免打扰" Click="OnFriendDisturbMenuItemClick">
                    <MenuItem.Icon>
                        <avalonia:MaterialIcon Kind="BellOffOutline" />
                    </MenuItem.Icon>
                </MenuItem>
                <Separator Margin="5" />
                <MenuItem Header="删除聊天" Click="OnFriendClearMenuItemClick">
                    <MenuItem.Icon>
                        <avalonia:MaterialIcon Kind="DeleteOutline" />
                    </MenuItem.Icon>
                </MenuItem>
            </ContextMenu>
        </DataTemplate>
        <DataTemplate x:Key="GroupMenu" DataType="group:GroupRelationDto">
            <ContextMenu Padding="0,0,10,0" Closed="OnContextMenuClosed">
                <MenuItem IsVisible="{Binding IsTop}" Header="取消置顶" Click="OnGroupTopMenuItemClick">
                    <MenuItem.Icon>
                        <avalonia:MaterialIcon Kind="ArrowExpandDown" />
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem IsVisible="{Binding !IsTop}" Header="置顶聊天" Click="OnGroupTopMenuItemClick">
                    <MenuItem.Icon>
                        <avalonia:MaterialIcon Kind="ArrowCollapseUp" />
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="复制群ID" Click="OnGroupCopyIdClick">
                    <MenuItem.Icon>
                        <avalonia:MaterialIcon Kind="ContentCopy" />
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem IsVisible="{Binding CantDisturb}" Header="接收消息提醒"
                          Click="OnGroupDisturbMenuItemClick">
                    <MenuItem.Icon>
                        <avalonia:MaterialIcon Kind="BellOutline" />
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem IsVisible="{Binding !CantDisturb}" Header="消息免打扰"
                          Click="OnGroupDisturbMenuItemClick">
                    <MenuItem.Icon>
                        <avalonia:MaterialIcon Kind="BellOffOutline" />
                    </MenuItem.Icon>
                </MenuItem>
                <Separator Margin="5" />
                <MenuItem Header="删除聊天" Click="OnGroupClearMenuItemClick">
                    <MenuItem.Icon>
                        <avalonia:MaterialIcon Kind="DeleteOutline" />
                    </MenuItem.Icon>
                </MenuItem>
            </ContextMenu>
        </DataTemplate>
    </UserControl.Resources>
    <UserControl.Styles>
        <Style Selector="RadioButton.IsTop">
            <Setter Property="Background" Value="{DynamicResource SukiControlBorderBrush}" />
            <Style Selector="^ /template/ Border">
                <Setter Property="Opacity" Value="0.3" />
            </Style>
            <Style Selector="^:pointerover">
                <Setter Property="BorderBrush" Value="{DynamicResource SukiPrimaryColor25}" />
                <Style Selector="^ /template/ Border">
                    <Setter Property="Opacity" Value="0.3" />
                    <Setter Property="Background" Value="{DynamicResource SukiPrimaryColor25}" />
                    <Setter Property="CornerRadius" Value="5" />
                </Style>
                <Style Selector="^ /template/ ContentPresenter#PART_ContentPresenter">
                    <Setter Property="CornerRadius" Value="5" />
                </Style>
            </Style>
            <Style Selector="^:checked">
                <Setter Property="BorderBrush" Value="{DynamicResource SukiPrimaryColor50}" />
                <Style Selector="^ /template/ Border">
                    <Setter Property="Opacity" Value="0.3" />
                    <Setter Property="Background" Value="{DynamicResource SukiPrimaryColor75}" />
                    <Setter Property="CornerRadius" Value="13" />
                </Style>
                <Style Selector="^ /template/ ContentPresenter#PART_ContentPresenter">
                    <Setter Property="CornerRadius" Value="13" />
                </Style>
            </Style>
        </Style>
        <Style Selector="RadioButton.Enter:visible">
            <Style.Animations>
                <Animation Duration="0:0:0.3"
                           FillMode="Forward"
                           IterationCount="1"
                           Easing="CubicEaseInOut">
                    <KeyFrame Cue="0%">
                        <Setter Property="ScaleTransform.ScaleX" Value="0" />
                        <Setter Property="ScaleTransform.ScaleY" Value="0" />
                    </KeyFrame>
                    <KeyFrame Cue="100%">
                        <Setter Property="ScaleTransform.ScaleX" Value="1" />
                        <Setter Property="ScaleTransform.ScaleY" Value="1" />
                    </KeyFrame>
                </Animation>
            </Style.Animations>
        </Style>
    </UserControl.Styles>
    <UserControl.DataTemplates>
        <DataTemplate DataType="data:FriendChatDto">
            <RadioButton GroupName="Friends"
                         Margin="0"
                         RenderTransformOrigin="0.5,0.5"
                         Height="65"
                         Classes.IsTop="{Binding FriendRelatoinDto.IsTop}"
                         Classes="Chat Content Enter"
                         CornerRadius="0"
                         PointerPressed="Button_OnPointerPressed"
                         Click="Button_OnClick"
                         Command="{Binding ((vm:ChatLeftPanelViewModel)DataContext).FriendSelectionChangedCommand,RelativeSource={RelativeSource AncestorType=ItemsControl,Mode=FindAncestor}}"
                         CommandParameter="{Binding }">
                <Grid Name="Root_Grid" ColumnDefinitions="42,*">
                    <!-- 头像 -->
                    <circleImage:CircleImage Image="{Binding FriendRelatoinDto.UserDto.HeadImage}" Size="42" />
                    <!-- 简略信息 -->
                    <Grid Grid.Column="1" RowDefinitions="1.2*,1*" Margin="10,4,0,4">
                        <Grid Grid.Row="0" ColumnDefinitions="*,auto">
                            <Grid Grid.Column="0">
                                <TextBlock
                                    IsVisible="{Binding FriendRelatoinDto.Remark,Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                                    HorizontalAlignment="Left"
                                    VerticalAlignment="Center"
                                    TextTrimming="CharacterEllipsis"
                                    Foreground="{DynamicResource SukiText}"
                                    Text="{Binding  FriendRelatoinDto.Remark}" />
                                <TextBlock
                                    IsVisible="{Binding FriendRelatoinDto.Remark,Converter={x:Static StringConverters.IsNullOrEmpty}}"
                                    HorizontalAlignment="Left"
                                    VerticalAlignment="Center"
                                    TextTrimming="CharacterEllipsis"
                                    Foreground="{DynamicResource SukiText}"
                                    Text="{Binding  FriendRelatoinDto.UserDto.Name}" />
                            </Grid>
                            <TextBlock Grid.Column="1" HorizontalAlignment="Right"
                                       Name="Time_Text"
                                       VerticalAlignment="Top"
                                       Foreground="{DynamicResource SukiText}"
                                       Text="{Binding LastChatMessages.Time,Converter={StaticResource DateTimeConverter}}"
                                       Margin="0,5"
                                       Opacity="0.6"
                                       FontSize="11.5" />
                        </Grid>
                        <Grid Grid.Row="1" ColumnDefinitions="*,auto">
                            <TextBlock Grid.Column="0"
                                       Name="Chat_Mess_Txt"
                                       VerticalAlignment="Center"
                                       FontSize="12"
                                       Opacity="0.6"
                                       Margin="0,0,20,0"
                                       TextTrimming="CharacterEllipsis"
                                       Foreground="{DynamicResource SukiText}"
                                       Text="{Binding LastChatMessages.ChatMessages,Converter={StaticResource ChatMessageToStringConverter}}" />
                            <Panel Grid.Column="1">
                                <Panel
                                    IsVisible="{Binding UnReadMessageCount,Converter={converter:IntEqualityConverter Value=0}}">
                                    <avalonia:MaterialIcon Kind="BellOffOutline" Width="16" Height="16"
                                                           IsVisible="{Binding FriendRelatoinDto.CantDisturb}"
                                                           Opacity="0.4" />
                                </Panel>
                                <Border Height="16"
                                        CornerRadius="8"
                                        Padding="5,0"
                                        Margin="0,0"
                                        Classes.CantDisturb="{Binding FriendRelatoinDto.CantDisturb}"
                                        HorizontalAlignment="Right"
                                        IsVisible="{Binding UnReadMessageCount,Converter={converter:IntEqualityConverter Equal=False,Value=0}}">
                                    <Border.Styles>
                                        <Style Selector="Border">
                                            <Setter Property="Background" Value="Red" />
                                        </Style>
                                        <Style Selector="Border.CantDisturb">
                                            <Setter Property="Background"
                                                    Value="{DynamicResource SukiMediumBorderBrush}" />
                                        </Style>
                                    </Border.Styles>
                                    <TextBlock FontSize="11"
                                               Margin="0,0,0,1"
                                               HorizontalAlignment="Center"
                                               Foreground="White"
                                               VerticalAlignment="Center"
                                               Text="{Binding UnReadMessageCount,Converter={converter:UnReadMessageCountConverter}}" />
                                </Border>
                            </Panel>
                        </Grid>
                    </Grid>
                </Grid>
            </RadioButton>
        </DataTemplate>
        <DataTemplate DataType="group:GroupChatDto">
            <RadioButton GroupName="Friends"
                         Margin="0"
                         Height="65"
                         RenderTransformOrigin="0.5,0.5"
                         Classes="Chat Content Enter"
                         Classes.IsTop="{Binding GroupRelationDto.IsTop}"
                         PointerPressed="Button_OnPointerPressed"
                         Click="Button_OnClick"
                         CornerRadius="0"
                         Command="{Binding ((vm:ChatLeftPanelViewModel)DataContext).GroupSelectionChangedCommand,RelativeSource={RelativeSource AncestorType=ItemsControl,Mode=FindAncestor}}"
                         CommandParameter="{Binding }">
                <Grid Name="Root_Grid" ColumnDefinitions="42,*">
                    <!-- 头像 -->
                    <circleImage:CircleImage Image="{Binding GroupRelationDto.GroupDto.HeadImage}" Size="42" />
                    <!-- 简略信息 -->
                    <Grid Grid.Column="1" RowDefinitions="1.2*,1*" Margin="10,4,0,4">
                        <Grid Grid.Row="0" ColumnDefinitions="*,auto">
                            <Grid Grid.Column="0">
                                <TextBlock
                                    IsVisible="{Binding GroupRelationDto.Remark,Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                                    HorizontalAlignment="Left"
                                    VerticalAlignment="Center"
                                    TextTrimming="CharacterEllipsis"
                                    FontWeight="Medium"
                                    Foreground="{DynamicResource SukiText}"
                                    Text="{Binding  GroupRelationDto.Remark}" />
                                <TextBlock
                                    IsVisible="{Binding GroupRelationDto.Remark,Converter={x:Static StringConverters.IsNullOrEmpty}}"
                                    HorizontalAlignment="Left"
                                    VerticalAlignment="Center"
                                    TextTrimming="CharacterEllipsis"
                                    FontWeight="Medium"
                                    Foreground="{DynamicResource SukiText}"
                                    Text="{Binding  GroupRelationDto.GroupDto.Name}" />
                            </Grid>
                            <TextBlock Grid.Column="1"
                                       HorizontalAlignment="Right"
                                       Name="Time_Text"
                                       VerticalAlignment="Top"
                                       Foreground="{DynamicResource SukiText}"
                                       Text="{Binding LastChatMessages.Time,Converter={StaticResource DateTimeConverter}}"
                                       Margin="0,5"
                                       Opacity="0.6"
                                       FontSize="11.5" />
                        </Grid>
                        <Grid Grid.Row="1" ColumnDefinitions="*,auto">
                            <Grid Grid.Column="0"
                                  IsVisible="{Binding LastChatMessages,Converter={converter:NullValueConverter}}">
                                <TextBlock IsVisible="{Binding !LastChatMessages.IsSystem}"
                                           VerticalAlignment="Center"
                                           FontSize="12"
                                           Margin="0,0,20,0"
                                           Opacity="0.6"
                                           TextTrimming="CharacterEllipsis"
                                           Foreground="{DynamicResource SukiText}">
                                    <Run Text="{Binding LastChatMessages.Owner.NickName}" />
                                    <Run Text=":" />
                                    <Run
                                        Text="{Binding LastChatMessages.ChatMessages,Mode=OneWay,Converter={StaticResource ChatMessageToStringConverter}}" />
                                </TextBlock>
                                <TextBlock IsVisible="{Binding LastChatMessages.IsSystem}"
                                           VerticalAlignment="Center"
                                           FontSize="12"
                                           Margin="0,0,20,0"
                                           Opacity="0.6"
                                           TextTrimming="CharacterEllipsis"
                                           Foreground="{DynamicResource SukiText}">
                                    <Run
                                        Text="{Binding LastChatMessages.ChatMessages,Mode=OneWay,Converter={StaticResource ChatMessageToStringConverter}}" />
                                </TextBlock>
                            </Grid>
                            <Panel Grid.Column="1">
                                <Panel
                                    IsVisible="{Binding UnReadMessageCount,Converter={converter:IntEqualityConverter Value=0}}">
                                    <avalonia:MaterialIcon Kind="BellOffOutline" Width="16" Height="16"
                                                           IsVisible="{Binding GroupRelationDto.CantDisturb}"
                                                           Opacity="0.4" />
                                </Panel>
                                <Border Height="16"
                                        CornerRadius="8"
                                        Padding="5,0"
                                        Margin="0,0"
                                        Classes.CantDisturb="{Binding GroupRelationDto.CantDisturb}"
                                        HorizontalAlignment="Right"
                                        IsVisible="{Binding UnReadMessageCount,Converter={converter:IntEqualityConverter Equal = False, Value=0}}">
                                    <Border.Styles>
                                        <Style Selector="Border">
                                            <Setter Property="Background" Value="Red" />
                                        </Style>
                                        <Style Selector="Border.CantDisturb">
                                            <Setter Property="Background"
                                                    Value="{DynamicResource SukiMediumBorderBrush}" />
                                        </Style>
                                    </Border.Styles>
                                    <TextBlock FontSize="11"
                                               Margin="0,0,0,1"
                                               HorizontalAlignment="Center"
                                               Foreground="White"
                                               VerticalAlignment="Center"
                                               Text="{Binding UnReadMessageCount,Converter={converter:UnReadMessageCountConverter}}" />
                                </Border>
                            </Panel>
                        </Grid>
                    </Grid>
                </Grid>
            </RadioButton>
        </DataTemplate>
    </UserControl.DataTemplates>
    <chatViews:ChatLeftPanelView.FriendItemsSource>
        <Binding Path="ChatViewModel.Friends" />
    </chatViews:ChatLeftPanelView.FriendItemsSource>
    <chatViews:ChatLeftPanelView.GroupItemsSource>
        <Binding Path="ChatViewModel.Groups" />
    </chatViews:ChatLeftPanelView.GroupItemsSource>
    <Grid Margin="0" RowDefinitions="70,*">
        <suki:GlassCard Padding="0" Margin="0" CornerRadius="0" Opacity="0.5" Grid.Row="0" Grid.RowSpan="2" />
        <!-- 顶部 -->
        <suki:GlassCard Padding="8"
                        Grid.Row="0"
                        CornerRadius="2"
                        Height="70"
                        Margin="0,0,0,0"
                        BorderThickness="0,0,0,1.5">
            <DockPanel LastChildFill="True">
                <Button Classes="Add"
                        Name="PART_AddButton"
                        CornerRadius="8"
                        Padding="0"
                        Margin="7,3,0,1"
                        VerticalAlignment="Bottom"
                        DockPanel.Dock="Right"
                        Click="PART_AddButton_OnClick"
                        Height="27"
                        Width="27"
                        Background="{DynamicResource SukiBorderBrush}">
                    <avalonia:MaterialIcon Kind="Plus" HorizontalAlignment="Center" />
                </Button>
                <searchBox:SearchBox WaterMask="搜索" SearchText="{Binding SearchText}" />
            </DockPanel>
        </suki:GlassCard>
        <!-- 好友列表 -->
        <ScrollViewer HorizontalScrollBarVisibility="Disabled"
                      Grid.Row="1"
                      VerticalScrollBarVisibility="Hidden">
            <ItemsControl x:Name="Items"
                          Margin="0,0,0,40"
                          suki:ItemsControlExtensions.AnimatedScroll="True">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <StackPanel Orientation="Vertical" />
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.Styles>
                    <Style Selector="RadioButton.Content">
                        <Style Selector="^ Grid#Root_Grid">
                            <Setter Property="Margin" Value="6,5,6,5" />
                            <Setter Property="Transitions">
                                <Transitions>
                                    <ThicknessTransition Property="Margin" Duration="0:0:0.25"
                                                         Easing="SineEaseInOut" />
                                </Transitions>
                            </Setter>
                        </Style>
                    </Style>

                    <Style Selector="RadioButton.Content:checked">
                        <Style Selector="^ Grid#Root_Grid">
                            <Setter Property="Margin" Value="17,5,17,5" />
                        </Style>
                    </Style>
                </ItemsControl.Styles>
            </ItemsControl>
        </ScrollViewer>
    </Grid>
</UserControl>